<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Komentar & Rating – Muslih Fvnky Shop</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --accent1: #06b6d4;
      --accent2: #3b82f6;
      --accent3: #9333ea;
    }
    html,body { height:100%; margin:0; }
    body {
      background-image: url('https://i.imgur.com/p0K2KQs.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #fff;
    }
    .overlay { min-height:100vh; background: rgba(0,0,0,0.72); padding: 2rem 1rem; }
    .card { background: rgba(255,255,255,0.04); backdrop-filter: blur(6px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); }
    .star { font-size: 1.6rem; cursor: pointer; user-select: none; transition: transform .12s ease; }
    .star:hover { transform: translateY(-3px); }
    .star.filled { color: #f6c94d; } /* gold */
    .thumb { max-width: 160px; max-height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); }
    .progress { height: 8px; background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; }
    .progress > i { display: block; height: 100%; background: linear-gradient(90deg,var(--accent1),var(--accent2)); width: 0%; transition: width .2s linear; }
    .muted { color: rgba(255,255,255,0.6); }
    .rating-large { font-size: 1.4rem; font-weight: 800; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    /* header gradient (like index) */
    .animated-gradient {
      background: linear-gradient(-45deg, #106EBE, #0FFCBE, #106EBE, #0FFCBE);
      background-size: 400% 400%;
      animation: gradientMove 6s ease infinite;
      padding: .6rem 1rem;
      border-radius: 12px;
      display:flex;
      align-items:center;
      gap: .75rem;
      max-width: 1000px;
      margin: 0 auto 1.25rem auto;
      box-shadow: 0 6px 30px rgba(0,0,0,0.45);
    }
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* responsive notes */
    @media (min-width:1024px){
      .thumb { max-width: 200px; max-height: 140px; }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <!-- header -->
    <header class="animated-gradient" role="banner">
      <img src="https://i.imgur.com/4jIRft9.jpeg" alt="Logo Muslih Fvnky" style="width:48px;height:48px;border-radius:12px;object-fit:cover;">
      <div>
        <div style="font-weight:700">Muslih Fvnky Shop</div>
        <div style="font-size:13px;opacity:.9">Komentar & Rating Pelanggan</div>
      </div>
      <div style="margin-left:auto">
        <a href="index.html" style="background:rgba(255,255,255,0.95); color:#000; padding:.4rem .6rem; border-radius:999px; font-weight:700; text-decoration:none;">← Kembali ke Toko</a>
      </div>
    </header>

    <main class="max-w-5xl mx-auto">
      <!-- stats -->
      <section class="card p-4 mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <div class="text-xs text-white/70">Rata-rata rating</div>
          <div class="flex items-center gap-3 mt-1">
            <div id="avgRatingVisual" class="rating-large">—</div>
            <div id="avgStars" class="text-yellow-400">☆☆☆☆☆</div>
            <div class="text-sm text-white/70">(<span id="totalCount">—</span> ulasan)</div>
          </div>
        </div>
        <div class="text-sm text-white/70 muted">Komentar tampil otomatis setelah pengiriman.</div>
      </section>

      <!-- form -->
      <section class="card p-5 mb-6">
        <form id="commentForm" class="space-y-3" autocomplete="off">
          <div>
            <label class="block text-sm text-white/90 font-medium">Nama</label>
            <input id="username" name="name" type="text" required class="mt-1 w-full rounded-md p-2 text-black" placeholder="Nama kamu (atau panggilan)">
          </div>

          <div>
            <label class="block text-sm text-white/90 font-medium">Komentar</label>
            <textarea id="comment" name="comment" rows="3" required class="mt-1 w-full rounded-md p-2 text-black" placeholder="Tulis pengalamanmu (contoh: pesan cepat & kualitas bagus)"></textarea>
          </div>

          <div>
            <label class="block text-sm text-white/90 font-medium mb-1">Rating</label>
            <div id="ratingStars" class="flex gap-2" role="radiogroup" aria-label="Rating bintang">
              <span class="star" data-value="1" role="radio" aria-checked="false">☆</span>
              <span class="star" data-value="2" role="radio" aria-checked="false">☆</span>
              <span class="star" data-value="3" role="radio" aria-checked="false">☆</span>
              <span class="star" data-value="4" role="radio" aria-checked="false">☆</span>
              <span class="star" data-value="5" role="radio" aria-checked="false">☆</span>
            </div>
            <p id="ratingHint" class="text-xs text-white/60 mt-1">Klik satu bintang untuk memilih rating.</p>
          </div>

          <div>
            <label class="block text-sm text-white/90 font-medium mb-1">Upload Foto (opsional, max 5 MB)</label>
            <div class="flex items-center gap-3">
              <input id="photoInput" name="file" type="file" accept="image/*" class="text-white" />
              <div id="previewWrap" class="flex items-center gap-2"></div>
            </div>

            <div id="uploadProgress" class="mt-2 hidden" aria-hidden="true">
              <div class="progress"><i id="progressBar"></i></div>
              <div class="text-xs muted mt-1" id="progressText">0%</div>
            </div>
          </div>

          <div class="flex gap-3 items-center">
            <button id="submitBtn" type="submit" class="bg-[#0FFCBE] text-black font-bold px-4 py-2 rounded-md">Kirim Komentar</button>
            <button type="button" id="clearBtn" class="bg-white/10 text-white px-3 py-2 rounded-md">Reset</button>
            <div id="statusMsg" class="text-sm text-white/80 ml-2"></div>
          </div>
        </form>
      </section>

      <!-- comments list -->
      <section id="commentsList" class="space-y-4 mb-8">
        <div class="card p-4 text-center muted">Memuat komentar...</div>
      </section>

      <footer class="mt-8 text-xs text-white/60">
        © 2025 Muslih Fvnky Shop — Testimoni ditampilkan publik.
      </footer>
    </main>
  </div>

  <script>
    // UI refs
    const form = document.getElementById('commentForm');
    const usernameEl = document.getElementById('username');
    const commentEl = document.getElementById('comment');
    const ratingStars = document.querySelectorAll('#ratingStars .star');
    const ratingHint = document.getElementById('ratingHint');
    const photoInput = document.getElementById('photoInput');
    const previewWrap = document.getElementById('previewWrap');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusMsg = document.getElementById('statusMsg');
    const commentsList = document.getElementById('commentsList');
    const totalCount = document.getElementById('totalCount');
    const avgRatingVisual = document.getElementById('avgRatingVisual');
    const avgStars = document.getElementById('avgStars');

    let selectedRating = 0;
    let selectedFile = null;
    const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5MB

    // stars behavior
    ratingStars.forEach(star => {
      star.addEventListener('click', () => {
        selectedRating = Number(star.dataset.value);
        updateStars(selectedRating);
      });
      star.addEventListener('mouseenter', () => highlightStars(Number(star.dataset.value)));
      star.addEventListener('mouseleave', () => updateStars(selectedRating));
    });

    function highlightStars(r) {
      ratingStars.forEach(s => s.classList.toggle('filled', Number(s.dataset.value) <= r));
    }
    function updateStars(r) {
      ratingStars.forEach(s => {
        s.classList.toggle('filled', Number(s.dataset.value) <= r);
        s.textContent = Number(s.dataset.value) <= r ? '★' : '☆';
        s.setAttribute('aria-checked', Number(s.dataset.value) === r ? 'true' : 'false');
      });
      ratingHint.textContent = r ? `Kamu memilih ${r} bintang` : 'Klik satu bintang untuk memilih rating.';
    }

    // preview image
    photoInput.addEventListener('change', (e) => {
      previewWrap.innerHTML = '';
      uploadProgress.classList.add('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      selectedFile = null;

      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (!f.type.startsWith('image/')) {
        alert('Silakan pilih file gambar (jpg/png).');
        photoInput.value = '';
        return;
      }
      if (f.size > MAX_FILE_BYTES) {
        alert('Ukuran file terlalu besar. Maks 5 MB.');
        photoInput.value = '';
        return;
      }

      selectedFile = f;
      const img = document.createElement('img');
      img.className = 'thumb';
      img.alt = 'Preview foto';
      img.src = URL.createObjectURL(f);
      previewWrap.appendChild(img);
    });

    clearBtn.addEventListener('click', () => {
      form.reset();
      selectedRating = 0;
      selectedFile = null;
      photoInput.value = '';
      previewWrap.innerHTML = '';
      updateStars(0);
      statusMsg.textContent = '';
    });

    // Helper: upload via XHR so we have progress events
    function uploadFormData(formData) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/upload', true);

        xhr.upload.onprogress = function(e) {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = pct + '%';
            progressText.textContent = pct + '%';
            uploadProgress.classList.remove('hidden');
          }
        };

        xhr.onload = function() {
          try {
            const json = JSON.parse(xhr.responseText || '{}');
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve(json);
            } else {
              reject(new Error(json.error || ('HTTP ' + xhr.status)));
            }
          } catch (err) {
            reject(new Error('Invalid JSON response from server'));
          }
        };

        xhr.onerror = function() {
          reject(new Error('Network error during upload'));
        };

        xhr.send(formData);
      });
    }

    // Submit handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusMsg.textContent = '';
      const name = usernameEl.value.trim();
      const comment = commentEl.value.trim();

      if (!name || !comment) {
        alert('Isi nama & komentar terlebih dahulu.');
        return;
      }
      if (!selectedRating) {
        alert('Pilih rating (1–5 bintang).');
        return;
      }

      // prepare form data
      const fd = new FormData();
      fd.append('name', name);
      fd.append('comment', comment);
      fd.append('rating', String(selectedRating));
      if (selectedFile) fd.append('file', selectedFile, selectedFile.name);

      submitBtn.disabled = true;
      submitBtn.textContent = 'Mengirim...';
      uploadProgress.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = '0%';

      try {
        const resp = await uploadFormData(fd);
        if (resp && resp.success) {
          statusMsg.textContent = 'Komentar berhasil dikirim ✨';
          // reload comments list
          await loadComments(true);
          // reset form
          form.reset();
          selectedFile = null;
          previewWrap.innerHTML = '';
          selectedRating = 0;
          updateStars(0);
        } else {
          throw new Error(resp && resp.error ? resp.error : 'Server error');
        }
      } catch (err) {
        console.error('Submit error', err);
        alert('Gagal mengirim komentar. Buka console (F12) untuk detail.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Kirim Komentar';
        uploadProgress.classList.add('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
      }
    });

    // Load comments from server. Tries multiple locations:
    // 1) /api/comments  (recommended: Vercel API that reads comments.json from Dropbox)
    // 2) /komentar-web/comments.json (if you made it publicly available)
    // 3) /comments.json (fallback)
    async function loadComments(forceReload=false) {
      commentsList.innerHTML = '<div class="card p-4 text-center muted">Memuat komentar...</div>';
      const urls = ['/api/comments', '/komentar-web/comments.json', '/comments.json'];
      let data = null;
      let lastErr = null;

      for (const u of urls) {
        try {
          const r = await fetch(u, { cache: forceReload ? 'no-store' : 'default' });
          if (!r.ok) {
            lastErr = `${u} -> ${r.status}`;
            continue;
          }
          const json = await r.json();
          // expect array
          if (Array.isArray(json)) {
            data = json;
            break;
          }
          // maybe wrapped {comments: [...]}
          if (json && Array.isArray(json.comments)) {
            data = json.comments;
            break;
          }
        } catch (err) {
          lastErr = err.message || String(err);
        }
      }

      if (!data) {
        commentsList.innerHTML = `<div class="card p-4 text-center text-yellow-200">Tidak dapat memuat komentar secara otomatis. Pastikan kamu punya <code>/api/comments</code> atau file <code>/komentar-web/comments.json</code>. Error terakhir: ${lastErr}</div>`;
        totalCount.textContent = '0';
        avgRatingVisual.textContent = '-';
        avgStars.innerHTML = '☆☆☆☆☆';
        return;
      }

      // render list
      if (data.length === 0) {
        commentsList.innerHTML = `<div class="card p-4 text-center">Belum ada komentar. Jadilah yang pertama!</div>`;
        totalCount.textContent = '0';
        avgRatingVisual.textContent = '-';
        avgStars.innerHTML = '☆☆☆☆☆';
        return;
      }

      let html = '';
      let total = 0;
      data.forEach(item => {
        const name = item.name || item.username || 'Anonim';
        const comment = item.comment || '';
        const rating = Number(item.rating || 0);
        const createdAt = item.createdAt ? new Date(item.createdAt).toLocaleString() : '';
        const imageUrl = item.imageUrl || item.link || null; // tolerate multiple fields

        total += rating;

        html += `<div class="card p-4 flex gap-4 flex-col md:flex-row items-start">
          ${ imageUrl ? `<div style="flex:0 0 auto"><img src="${escapeHtml(imageUrl)}" alt="Foto testimoni" class="thumb"></div>` : '' }
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.35rem">
              <div style="font-weight:700">${escapeHtml(name)}</div>
              <div style="color:#F6C94D">${'★'.repeat(rating)}${'☆'.repeat(5-rating)}</div>
            </div>
            <div style="font-size:14px;color:rgb(240,240,240)">${escapeHtml(comment)}</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:.6rem">${escapeHtml(createdAt)}</div>
          </div>
        </div>`;
      });

      commentsList.innerHTML = html;
      totalCount.textContent = String(data.length);
      const avg = (total / data.length) || 0;
      avgRatingVisual.textContent = avg ? avg.toFixed(2) : '-';
      const full = Math.round(avg);
      avgStars.innerHTML = '★'.repeat(full) + '☆'.repeat(5-full);
    }

    // basic escaping for HTML injection safety
    function escapeHtml(s) {
      if (!s && s!==0) return '';
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    // initial
    updateStars(0);
    loadComments();

    // auto refresh every 18s (optional)
    setInterval(() => loadComments(true), 18000);
  </script>
</body>
</html>
