<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Komentar — Muslih Fvnky Shop</title>
  <style>
    /* Simple styling inspired by your green/shopee-like look */
    :root{
      --bg1:#002f2a;
      --bg2:#044d44;
      --card:#0b3e39;
      --muted:#cbd5d1;
      --accent:#00d3a1;
      --danger:#ff5555;
      --yellow:#ffd24d;
    }
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: radial-gradient( circle at 10% 10%, rgba(0,128,110,0.35), rgba(2,40,35,0.8) 40% ), linear-gradient(180deg, rgba(0,78,66,0.25), rgba(0,40,36,0.6));
      color:#e6f6f0;
      -webkit-font-smoothing:antialiased;
    }
    .wrap{max-width:820px;margin:30px auto;padding:24px;}
    .header{display:flex;gap:16px;align-items:center;margin-bottom:18px;}
    h1{font-size:34px;margin:0;color:#fff;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.05));border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.5);margin-bottom:18px;}
    label{display:block;font-weight:700;margin-bottom:8px;color:var(--muted);}
    input[type=text], textarea{
      width:100%;padding:14px;border-radius:12px;border:none;background:#f1f6f5;color:#072824;font-size:16px;box-sizing:border-box;
    }
    textarea{min-height:120px;resize:vertical;}
    .row{display:flex;gap:12px;align-items:center;margin-top:12px;}
    .btn{
      display:inline-block;padding:12px 18px;border-radius:10px;border:none;background:var(--accent);color:#00322a;font-weight:700;cursor:pointer;box-shadow:0 6px 0 rgba(0,0,0,0.2);
    }
    .btn.secondary{background:#375a58;color:#dff6ef;box-shadow:none;font-weight:700}
    .file-info{color:var(--muted);margin-left:12px;font-weight:600}
    .stars{display:flex;gap:8px;align-items:center}
    .star{font-size:26px;color:rgba(255,255,255,0.4);cursor:pointer}
    .star.active{color:var(--yellow)}
    .notice{background:rgba(0,0,0,0.25);padding:12px;border-radius:10px;margin-top:14px;color:#fff}
    .comments-list{margin-top:18px;display:flex;flex-direction:column;gap:12px}
    .citem{background:rgba(0,0,0,0.25);padding:12px;border-radius:12px;display:flex;gap:12px;align-items:flex-start}
    .cimg{width:72px;height:72px;border-radius:10px;object-fit:cover;flex:0 0 72px}
    .cbody{flex:1}
    .cname{font-weight:800}
    .crating{color:var(--yellow);margin-top:6px}
    .ctime{font-size:12px;color:var(--muted);margin-top:6px}
    .error{color:#ffecec;background:#5b2b2b;padding:10px;border-radius:10px;margin-top:10px}
    .success{color:#054f37;background:#b7f3db;padding:10px;border-radius:10px;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div style="width:64px;height:64px;border-radius:50%;background:#033a33;display:flex;align-items:center;justify-content:center;font-weight:800">MF</div>
      <div>
        <h1>Komentar Pengunjung</h1>
        <div style="color:var(--muted)">Pengunjung dapat memberi rating, komentar, dan upload foto — tampil otomatis.</div>
      </div>
    </div>

    <div class="card">
      <div>
        <label for="name">Nama</label>
        <input id="name" type="text" placeholder="Nama kamu (atau panggilan)">
      </div>

      <div style="margin-top:12px">
        <label for="comment">Komentar</label>
        <textarea id="comment" placeholder="Tulis pengalamanmu (contoh: pesan cepat & kualitas bagus)"></textarea>
      </div>

      <div style="margin-top:12px">
        <label>Rating</label>
        <div class="stars" id="stars">
          <span class="star" data-value="1">☆</span>
          <span class="star" data-value="2">☆</span>
          <span class="star" data-value="3">☆</span>
          <span class="star" data-value="4">☆</span>
          <span class="star" data-value="5">☆</span>
          <div style="margin-left:auto;color:var(--muted)" id="rating-text">Klik satu bintang untuk memilih rating.</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Upload Foto (opsional, max 5 MB)</label>
        <div style="display:flex;align-items:center">
          <input id="file" type="file" accept="image/*" />
          <div class="file-info" id="file-name">Tidak ada file yang dipilih</div>
        </div>
        <div style="height:8px;background:rgba(255,255,255,0.06);border-radius:999px;margin-top:8px">
          <div id="progress" style="width:0%;height:8px;background:linear-gradient(90deg,var(--accent),#00ffa1);border-radius:999px"></div>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn" id="sendBtn">Kirim Komentar</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
        <div id="statusMsg" style="margin-left:12px"></div>
      </div>

    </div>

    <div id="commentsContainer">
      <div id="commentsList" class="comments-list"></div>
    </div>

  </div>

<script>
  const stars = document.querySelectorAll('.star');
  let currentRating = 0;
  const ratingText = document.getElementById('rating-text');
  stars.forEach(s => {
    s.addEventListener('click', () => {
      currentRating = Number(s.dataset.value);
      updateStars();
    });
  });
  function updateStars() {
    stars.forEach(s => {
      if (Number(s.dataset.value) <= currentRating) s.classList.add('active'), s.textContent='★';
      else s.classList.remove('active'), s.textContent='☆';
    });
    ratingText.textContent = currentRating ? `Kamu memilih ${currentRating} bintang` : 'Klik satu bintang untuk memilih rating.';
  }

  // file input
  const fileInput = document.getElementById('file');
  const fileNameEl = document.getElementById('file-name');
  let chosenFile = null;
  fileInput.addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) {
      fileNameEl.textContent = 'Tidak ada file yang dipilih';
      chosenFile = null;
      return;
    }
    if (f.size > 5 * 1024 * 1024) {
      alert('Ukuran file terlalu besar (max 5 MB)');
      fileInput.value = '';
      chosenFile = null;
      fileNameEl.textContent = 'Tidak ada file yang dipilih';
      return;
    }
    chosenFile = f;
    fileNameEl.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
  });

  const sendBtn = document.getElementById('sendBtn');
  const resetBtn = document.getElementById('resetBtn');
  const statusMsg = document.getElementById('statusMsg');

  async function readFileAsBase64(file){
    return await new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> resolve(fr.result);
      fr.onerror = err => reject(err);
      fr.readAsDataURL(file);
    });
  }

  async function sendComment(){
    statusMsg.innerHTML = '';
    sendBtn.disabled = true;
    sendBtn.textContent = 'Mengirim...';

    const name = document.getElementById('name').value.trim() || 'Anon';
    const comment = document.getElementById('comment').value.trim();
    if (!comment) {
      alert('Tulis komentar dulu');
      sendBtn.disabled = false;
      sendBtn.textContent = 'Kirim Komentar';
      return;
    }

    let fileBase64 = null;
    let filename = null;
    if (chosenFile) {
      try {
        fileBase64 = await readFileAsBase64(chosenFile);
        filename = chosenFile.name;
      } catch(err) {
        console.error(err);
      }
    }

    const payload = { name, comment, rating: currentRating, filename, fileBase64 };

    try{
      const resp = await fetch('/api/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        statusMsg.innerHTML = `<div class="error">❌ Error koneksi: ${data && data.error ? (data.error) : ('Server error')}</div>`;
        console.error(data);
      } else {
        statusMsg.innerHTML = `<div class="success">✓ Komentar berhasil dikirim</div>`;
        // reset form
        document.getElementById('comment').value = '';
        document.getElementById('name').value = '';
        fileInput.value = '';
        fileNameEl.textContent = 'Tidak ada file yang dipilih';
        chosenFile = null;
        currentRating = 0;
        updateStars();
        // reload comments
        await loadComments();
      }
    } catch (err){
      console.error(err);
      statusMsg.innerHTML = `<div class="error">❌ Error koneksi: ${err && err.message ? err.message : 'Server error'}</div>`;
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Kirim Komentar';
    }
  }

  resetBtn.addEventListener('click', ()=>{
    document.getElementById('comment').value = '';
    document.getElementById('name').value = '';
    fileInput.value = '';
    fileNameEl.textContent = 'Tidak ada file yang dipilih';
    chosenFile = null;
    currentRating = 0;
    updateStars();
    statusMsg.innerHTML = '';
  });

  sendBtn.addEventListener('click', sendComment);

  // load comments list
  async function loadComments(){
    try{
      const resp = await fetch('/api/upload?ts=' + Date.now());
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        console.error('Failed load comments', data);
        document.getElementById('commentsList').innerHTML = `<div class="notice">Tidak dapat memuat komentar secara otomatis. Pastikan endpoint /api/upload tersedia. (${data && data.error ? data.error : 'error'})</div>`;
        return;
      }

      const comments = data.comments || [];
      const cont = document.getElementById('commentsList');
      if (!comments.length) {
        cont.innerHTML = `<div class="card" style="text-align:center;color:var(--muted)">Belum ada komentar. Jadilah yang pertama!</div>`;
        return;
      }

      cont.innerHTML = '';
      for (const c of comments) {
        const cdiv = document.createElement('div');
        cdiv.className = 'citem';
        const imgHtml = c.photo ? `<img class="cimg" src="${c.photo}" alt="foto">` : '';
        cdiv.innerHTML = `
          ${imgHtml}
          <div class="cbody">
            <div class="cname">${escapeHtml(c.name || 'Anon')}</div>
            <div class="crating">${renderStars(c.rating || 0)}</div>
            <div style="margin-top:8px">${escapeHtml(c.comment)}</div>
            <div class="ctime">${new Date(c.timestamp || Date.now()).toLocaleString()}</div>
          </div>
        `;
        cont.appendChild(cdiv);
      }
    } catch(err) {
      console.error('Load comments error', err);
    }
  }

  function renderStars(n){
    let s='';
    for(let i=0;i<5;i++){
      s += i < n ? '★' : '☆';
    }
    return `<span style="color:var(--yellow)">${s}</span>`;
  }

  function escapeHtml(s){
    return (''+s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);
  }

  document.addEventListener('DOMContentLoaded', ()=> {
    updateStars();
    loadComments();
    // reload comments every 30s
    setInterval(loadComments, 30000);
  });
</script>
</body>
</html>
