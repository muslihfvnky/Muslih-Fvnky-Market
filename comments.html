<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Komentar — Muslih Fvnky Shop</title>

<!-- gaya mirip spin.html: teal gradient, gelap, rounded cards -->
<style>
  :root{
    --teal-1:#003f3a;
    --teal-2:#005a54;
    --glass: rgba(255,255,255,0.03);
    --card-grad: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
    --accent:#1fe1a3;
    --muted:#98b6ae;
    --danger:#ff6b6b;
    --radius:16px;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    color:#eaf7f2;
    background:
      radial-gradient(circle at 10% 20%, rgba(0,200,170,0.06), transparent 8%),
      linear-gradient(180deg,var(--teal-1), var(--teal-2));
    /* jika mau pakai background image mirip spin.html, ganti URL di bawah: */
    background-image: url('/assets/spin-bg.jpg'), linear-gradient(180deg,var(--teal-1), var(--teal-2));
    background-size: cover;
    background-blend-mode: overlay;
    padding:28px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .container{max-width:920px;margin:0 auto;}
  header{display:flex;gap:14px;align-items:center;margin-bottom:18px}
  .logo{width:72px;height:72px;border-radius:999px;background:linear-gradient(135deg,#071e20,#0b524b);display:flex;align-items:center;justify-content:center;font-weight:800}
  h1{font-size:28px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:14px}

  .card{
    margin-top:16px;
    border-radius:var(--radius);
    padding:22px;
    background: var(--card-grad);
    box-shadow: 0 12px 40px rgba(0,0,0,0.55);
    border:1px solid rgba(255,255,255,0.03);
  }

  label{display:block;color:#dff7ee;margin-bottom:8px;font-weight:700}
  input[type="text"], textarea{
    width:100%;padding:14px;border-radius:12px;border:none;background:var(--glass);color:#e9fef7;font-size:15px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
  }
  textarea{min-height:110px;resize:vertical}

  .rating-row{display:flex;align-items:center;gap:10px;margin-top:10px}
  .stars{display:flex;gap:6px}
  .star{font-size:26px;cursor:pointer;filter:drop-shadow(0 6px 10px rgba(0,0,0,0.6))}
  .star.on{color:#ffd24a}
  .rating-label{color:var(--muted);font-size:14px}

  .file-row{display:flex;align-items:center;gap:12px;margin-top:12px}
  .btn-file{background:#fff;color:#07211c;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .file-name{color:var(--muted);font-weight:700}

  .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:10px}
  .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#00a07f);border-radius:8px;transition:width .15s ease}

  .actions{display:flex;gap:12px;margin-top:16px}
  .btn{padding:12px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn-primary{background:var(--accent);color:#032b24;box-shadow:0 10px 30px rgba(0,150,120,0.12)}
  .btn-ghost{background:rgba(255,255,255,0.06);color:#dff7ee}
  .message{margin-top:14px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.35);display:flex;gap:10px;align-items:center;color:#ffdcdc}

  .list{margin-top:22px}
  .item{display:flex;gap:14px;align-items:flex-start;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
  .item .content{flex:1}
  .item img.thumb{width:92px;height:92px;border-radius:8px;object-fit:cover}

  @media (max-width:700px){
    .item{flex-direction:column}
    .item img.thumb{width:100%;height:160px}
    body{padding:14px}
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">MF</div>
      <div>
        <h1>Komentar & Rating — Muslih Fvnky Shop</h1>
        <p class="lead">Pengunjung dapat memberi rating, komentar, dan upload foto — tampil otomatis.</p>
      </div>
    </header>

    <main>
      <section class="card" id="formCard" aria-labelledby="judul">
        <div id="judul"><strong style="font-size:18px">Komentar Pengunjung</strong></div>

        <div style="margin-top:12px">
          <label for="nama">Nama</label>
          <input id="nama" type="text" placeholder="Nama kamu (atau panggilan)" />

          <label for="komentar" style="margin-top:12px">Komentar</label>
          <textarea id="komentar" placeholder="Tulis pengalamanmu"></textarea>

          <div class="rating-row">
            <div>
              <label style="margin-bottom:6px;display:block">Rating</label>
              <div class="stars" id="stars">
                <span class="star" data-val="1">☆</span>
                <span class="star" data-val="2">☆</span>
                <span class="star" data-val="3">☆</span>
                <span class="star" data-val="4">☆</span>
                <span class="star" data-val="5">☆</span>
              </div>
            </div>
            <div class="rating-label" id="ratingText">Klik satu bintang untuk memilih.</div>
          </div>

          <label style="margin-top:12px">Upload Foto (opsional, max 5 MB)</label>
          <div class="file-row">
            <label class="btn-file" id="pick">Pilih File</label>
            <div class="file-name" id="fname">Tidak ada file yang dipilih</div>
          </div>
          <input id="fileinput" type="file" accept="image/*" style="display:none" />

          <div class="progress" aria-hidden="true"><i id="bar"></i></div>

          <div class="actions">
            <button id="send" class="btn btn-primary">Kirim Komentar</button>
            <button id="reset" class="btn btn-ghost">Reset</button>
          </div>

          <div id="msgwrap"></div>
        </div>
      </section>

      <section class="list" id="komentarList" aria-live="polite"></section>
    </main>
  </div>

<script>
/* behavior:
 - kirim multipart ke /api/upload (POST)
 - parse respons aman (jika bukan JSON, tampilkan teksnya)
 - tampilkan gambar jika server mengembalikan fileUrl
 - env var di vercel: DROPBOX_TOKEN (server side)
*/

(function(){
  const stars = document.querySelectorAll('.star');
  const ratingText = document.getElementById('ratingText');
  let rating = 0;
  stars.forEach(s=>{
    s.addEventListener('click', ()=> {
      rating = Number(s.dataset.val);
      updateStars();
    });
  });
  function updateStars(){
    stars.forEach(s=>{
      const v = Number(s.dataset.val);
      s.classList.toggle('on', v <= rating);
      s.textContent = v <= rating ? '★' : '☆';
    });
    ratingText.textContent = rating ? 'Kamu memilih ' + rating + ' bintang' : 'Klik satu bintang untuk memilih.';
  }

  const pick = document.getElementById('pick');
  const fileinput = document.getElementById('fileinput');
  const fname = document.getElementById('fname');
  const bar = document.getElementById('bar');
  let file = null;

  pick.addEventListener('click', ()=> fileinput.click());
  fileinput.addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f){ file=null; fname.textContent='Tidak ada file yang dipilih'; return; }
    if(f.size > 5*1024*1024){ showMsg('Ukuran file lebih dari 5 MB', 'error'); fileinput.value=''; file=null; fname.textContent='Tidak ada file yang dipilih'; return; }
    file = f;
    fname.textContent = f.name + (f.size ? ' (' + Math.round(f.size/1024) + ' KB)' : '');
  });

  const send = document.getElementById('send');
  const reset = document.getElementById('reset');
  const nama = document.getElementById('nama');
  const komentar = document.getElementById('komentar');
  const msgwrap = document.getElementById('msgwrap');
  const komentarList = document.getElementById('komentarList');

  reset.addEventListener('click', ()=> {
    nama.value=''; komentar.value=''; rating=0; updateStars(); fileinput.value=''; file=null; fname.textContent='Tidak ada file yang dipilih'; bar.style.width='0%'; msgwrap.innerHTML='';
  });

  function showMsg(t, type){
    msgwrap.innerHTML = '';
    const d = document.createElement('div');
    d.className = 'message';
    if(type === 'ok') d.style.background = 'rgba(0,80,60,0.24)';
    if(type === 'error') d.style.background = 'rgba(80,0,0,0.24)';
    d.textContent = t;
    msgwrap.appendChild(d);
  }

  async function parseSafe(res){
    const txt = await res.text();
    try { return { ok: res.ok, data: JSON.parse(txt), raw: txt }; }
    catch(e){ return { ok: res.ok, data: null, raw: txt }; }
  }

  send.addEventListener('click', async ()=>{
    msgwrap.innerHTML='';
    const namaV = nama.value.trim();
    const komV = komentar.value.trim();
    if(!namaV || !komV){ showMsg('Nama dan komentar wajib diisi','error'); return; }

    const fd = new FormData();
    fd.append('nama', namaV);
    fd.append('komentar', komV);
    fd.append('rating', rating || 0);
    if(file) fd.append('file', file);

    send.disabled = true;
    send.textContent = 'Mengirim...';
    bar.style.width = '6%';

    try {
      const res = await fetch('/api/upload', { method: 'POST', body: fd });
      bar.style.width = '40%';
      const parsed = await parseSafe(res);

      if(!parsed.ok){
        // server error atau status != 2xx
        const err = parsed.data ? (parsed.data.error || JSON.stringify(parsed.data)) : parsed.raw;
        showMsg('Error koneksi: ' + err, 'error');
        bar.style.width = '0%';
      } else {
        // success status
        if(!parsed.data){
          showMsg('Respons server bukan JSON: ' + parsed.raw, 'error');
          bar.style.width='0%';
        } else if(parsed.data.success){
          showMsg('Komentar berhasil dikirim!', 'ok');
          bar.style.width='100%';
          // tambahkan ke daftar komentar
          addComment({
            nama: parsed.data.nama || namaV,
            komentar: parsed.data.komentar || komV,
            rating: parsed.data.rating || rating,
            fileUrl: parsed.data.fileUrl || null,
            date: new Date().toISOString()
          });
          // reset form kecil
          nama.value=''; komentar.value=''; rating=0; updateStars(); fileinput.value=''; file=null; fname.textContent='Tidak ada file yang dipilih';
          setTimeout(()=> bar.style.width='0%', 800);
        } else {
          showMsg(parsed.data.error || 'Upload gagal', 'error');
          bar.style.width='0%';
        }
      }
    } catch(e){
      console.error(e);
      showMsg('Server error', 'error');
      bar.style.width='0%';
    } finally {
      send.disabled = false;
      send.textContent = 'Kirim Komentar';
    }
  });

  function addComment(c){
    const it = document.createElement('div');
    it.className = 'item';
    const date = new Date(c.date || Date.now()).toLocaleString();
    it.innerHTML = `
      <div class="content">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong style="font-size:16px">${escapeHtml(c.nama||'Anonim')}</strong>
            <div style="color:var(--muted);font-size:12px">${date}</div>
          </div>
          ${c.fileUrl ? `<img src="${escapeAttr(c.fileUrl)}" class="thumb" alt="foto komentar" />` : ''}
        </div>
        <div style="margin-top:10px;color:#eaf7f1">${renderStars(c.rating||0)}</div>
        <div style="margin-top:10px">${escapeHtml(c.komentar||'')}</div>
      </div>
    `;
    komentarList.insertBefore(it, komentarList.firstChild);
  }

  function renderStars(v){
    v = Number(v)||0;
    let out='';
    for(let i=1;i<=5;i++) out += i<=v ? '★' : '☆';
    return `<span style="color:#ffd24a;font-size:16px">${out}</span>`;
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, ch=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));}
  function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }

  // optional: muat comments.json jika kamu punya
  (async function loadComments(){
    try{
      const r = await fetch('/comments.json');
      if(!r.ok) return;
      const arr = await r.json();
      if(Array.isArray(arr)) arr.forEach(addComment);
    }catch(e){}
  })();

})();
</script>
</body>
</html>
