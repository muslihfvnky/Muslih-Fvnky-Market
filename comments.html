<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Komentar Pengunjung</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #04323d, #065f46);
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
    }
    .star {
      font-size: 2rem;
      cursor: pointer;
      color: #d1d5db;
    }
    .star.selected {
      color: #facc15;
    }
  </style>
</head>
<body class="flex flex-col items-center p-4">
  <div class="w-full max-w-2xl bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-lg text-white">
    <h1 class="text-2xl font-bold mb-4">Komentar Pengunjung ⭐</h1>

    <!-- Form Komentar -->
    <form id="commentForm" class="space-y-4">
      <div>
        <label class="block mb-1">Nama</label>
        <input type="text" id="name" required class="w-full p-2 rounded-lg text-black" placeholder="Nama Anda">
      </div>

      <div>
        <label class="block mb-1">Komentar</label>
        <textarea id="comment" required class="w-full p-2 rounded-lg text-black" rows="3" placeholder="Tulis komentar Anda..."></textarea>
      </div>

      <div>
        <label class="block mb-1">Rating</label>
        <div id="rating" class="flex space-x-2">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>
      </div>

      <div>
        <label class="block mb-1">Upload Foto (opsional, max 5 MB)</label>
        <input type="file" id="photo" accept="image/*" class="w-full text-white">
      </div>

      <div class="flex space-x-2">
        <button type="submit" class="bg-emerald-500 px-4 py-2 rounded-lg hover:bg-emerald-600">Kirim Komentar</button>
        <button type="reset" class="bg-gray-500 px-4 py-2 rounded-lg hover:bg-gray-600">Reset</button>
      </div>
    </form>

    <!-- Notifikasi -->
    <p id="statusMsg" class="mt-4 text-center hidden"></p>

    <!-- Daftar Komentar -->
    <div id="commentsList" class="mt-8 space-y-4"></div>
  </div>

  <script>
    // Rating sistem
    let selectedRating = 0;
    document.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', () => {
        selectedRating = star.getAttribute('data-value');
        document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
        for (let i = 0; i < selectedRating; i++) {
          document.querySelectorAll('.star')[i].classList.add('selected');
        }
      });
    });

    // Submit form
    document.getElementById('commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const comment = document.getElementById('comment').value.trim();
      const file = document.getElementById('photo').files[0];
      const statusMsg = document.getElementById('statusMsg');

      if (!selectedRating) {
        statusMsg.textContent = "Silakan pilih rating ⭐";
        statusMsg.className = "mt-4 text-center text-yellow-400";
        statusMsg.classList.remove("hidden");
        return;
      }

      const formData = new FormData();
      formData.append("name", name);
      formData.append("comment", comment);
      formData.append("rating", selectedRating);
      if (file) formData.append("photo", file);

      try {
        const res = await fetch("/api/upload", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();
        if (res.ok) {
          statusMsg.textContent = "✅ Komentar berhasil dikirim!";
          statusMsg.className = "mt-4 text-center text-green-400";
          statusMsg.classList.remove("hidden");
          document.getElementById("commentForm").reset();
          selectedRating = 0;
          document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
          loadComments();
        } else {
          statusMsg.textContent = "❌ Gagal mengirim: " + (data.error || "Server error");
          statusMsg.className = "mt-4 text-center text-red-400";
          statusMsg.classList.remove("hidden");
        }
      } catch (err) {
        statusMsg.textContent = "❌ Error koneksi: " + err.message;
        statusMsg.className = "mt-4 text-center text-red-400";
        statusMsg.classList.remove("hidden");
      }
    });

    // Load komentar
    async function loadComments() {
      try {
        const res = await fetch("https://dl.dropboxusercontent.com/scl/fi/3l5vtyby70p8rj9hd7l1n/comments.json?rlkey=d92c7nngiwx54y0ukzdx8g9b3&dl=0");
        if (!res.ok) return;
        const comments = await res.json();
        const list = document.getElementById("commentsList");
        list.innerHTML = "";
        comments.reverse().forEach(c => {
          const div = document.createElement("div");
          div.className = "p-4 bg-white/20 rounded-lg";
          div.innerHTML = `
            <p class="font-bold">${c.name} <span class="text-yellow-400">(${c.rating}⭐)</span></p>
            <p>${c.comment}</p>
            ${c.photo ? `<img src="${c.photo}" class="mt-2 max-h-40 rounded-lg">` : ""}
          `;
          list.appendChild(div);
        });
      } catch (err) {
        console.error("Gagal load komentar:", err);
      }
    }

    loadComments();
  </script>
</body>
</html>
