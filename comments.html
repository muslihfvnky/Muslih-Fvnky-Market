<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Komentar & Rating – Muslih Fvnky Shop</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html,body { height:100%; margin:0; }
    body {
      background-image: url('https://i.imgur.com/p0K2KQs.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #fff;
    }
    .overlay { min-height:100vh; background: rgba(0,0,0,0.72); padding: 2rem 1rem; }
    .card { background: rgba(255,255,255,0.04); backdrop-filter: blur(6px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); }
    .star { font-size: 1.6rem; cursor: pointer; user-select: none; transition: transform .12s ease; }
    .star:hover { transform: translateY(-3px); }
    .star.filled { color: #f6c94d; } /* gold */
    .thumb { max-width: 120px; max-height: 90px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); }
    .progress { height: 8px; background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; }
    .progress > i { display: block; height: 100%; background: linear-gradient(90deg,#06b6d4,#3b82f6); width: 0%; transition: width .2s linear; }
    .muted { color: rgba(255,255,255,0.6); }
    .rating-large { font-size: 1.4rem; font-weight: 800; }
  </style>
</head>
<body>
  <div class="overlay">
    <main class="max-w-5xl mx-auto">
      <!-- Header -->
      <header class="mb-6 flex items-center gap-4">
        <img src="https://i.imgur.com/4jIRft9.jpeg" alt="Logo Muslih Fvnky" class="w-14 h-14 rounded-full ring-2 ring-[#0FFCBE]/60 object-cover">
        <div>
          <h1 class="text-2xl font-extrabold">💬 Komentar & Rating — Muslih Fvnky Shop</h1>
          <p class="text-sm text-white/80">Pengunjung bisa beri rating, komentar, dan upload foto. Semua tampil otomatis.</p>
        </div>
      </header>

      <!-- Stats (average + total) -->
      <section class="card p-4 mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <div class="text-xs text-white/70">Rata-rata rating</div>
          <div class="flex items-center gap-3 mt-1">
            <div id="avgRatingVisual" class="rating-large">—</div>
            <div id="avgStars" class="text-yellow-400">☆☆☆☆☆</div>
            <div class="text-sm text-white/70">(<span id="totalCount">—</span> ulasan)</div>
          </div>
        </div>

        <div class="text-sm text-white/70">
          <a href="index.html" class="inline-block px-4 py-2 rounded-full bg-white text-black font-medium shadow-md hover:scale-105 transition">← Kembali ke Toko</a>
        </div>
      </section>

      <!-- Form -->
      <section class="card p-5 mb-6">
        <form id="commentForm" class="space-y-3">
          <div>
            <label class="block text-sm text-white/90 font-medium">Nama</label>
            <input id="username" type="text" required class="mt-1 w-full rounded-md p-2 text-black" placeholder="Nama kamu (atau panggilan)">
          </div>

          <div>
            <label class="block text-sm text-white/90 font-medium">Komentar</label>
            <textarea id="comment" rows="3" required class="mt-1 w-full rounded-md p-2 text-black" placeholder="Tulis pengalamanmu (contoh: pesan cepat & kualitas bagus)"></textarea>
          </div>

          <div>
            <label class="block text-sm text-white/90 font-medium mb-1">Rating</label>
            <div id="ratingStars" class="flex gap-2">
              <span class="star" data-value="1">☆</span>
              <span class="star" data-value="2">☆</span>
              <span class="star" data-value="3">☆</span>
              <span class="star" data-value="4">☆</span>
              <span class="star" data-value="5">☆</span>
            </div>
            <p id="ratingHint" class="text-xs text-white/60 mt-1">Klik satu bintang untuk memilih rating.</p>
          </div>

          <div>
            <label class="block text-sm text-white/90 font-medium mb-1">Upload Foto (opsional, max 5 MB)</label>
            <div class="flex items-center gap-3">
              <input id="photoInput" type="file" accept="image/*" class="text-white" />
              <div id="previewWrap" class="flex items-center gap-2"></div>
            </div>

            <div id="uploadProgress" class="mt-2 hidden">
              <div class="progress"><i id="progressBar"></i></div>
              <div class="text-xs muted mt-1" id="progressText">0%</div>
            </div>
          </div>

          <div class="flex gap-3 items-center">
            <button id="submitBtn" type="submit" class="bg-[#0FFCBE] text-black font-bold px-4 py-2 rounded-md">Kirim Komentar</button>
            <button type="button" id="clearBtn" class="bg-white/10 text-white px-3 py-2 rounded-md">Reset</button>
          </div>
        </form>
      </section>

      <!-- Comments list -->
      <section id="commentsList" class="space-y-4 mb-8">
        <!-- komentar akan diinject di sini -->
      </section>

      <footer class="mt-8 text-xs text-white/60">
        © 2025 Muslih Fvnky Shop — Testimoni ditampilkan publik.
      </footer>
    </main>
  </div>

  <!-- Firebase (Firestore) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ====== Firebase config (dari akunmu) ======
    const firebaseConfig = {
      apiKey: "AIzaSyCzM4lTP69_lJq2KoaRLo_kGDgygSFQQ84",
      authDomain: "muslih-fvnky-shop.firebaseapp.com",
      projectId: "muslih-fvnky-shop",
      storageBucket: "muslih-fvnky-shop.firebasestorage.app",
      messagingSenderId: "339802914615",
      appId: "1:339802914615:web:2dd129c915c69ef5db24b2",
      measurementId: "G-XFWTMC8P6R"
    };
    // ============================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ========= DROPBOX CONFIG =========
    // ACCESS TOKEN yang kamu generate (jaga kerahasiaannya!)
    const DROPBOX_ACCESS_TOKEN = "sl.u.AF4bBl9_KhseZ1exdSm2eZcw0ulIfeuYGkHPFlj2IEkgr2DfObiJK6hHEFdRR_gJi7yrX7ufTQXcZllNeR-ItI63uC6sWIL2J_OiBcg4Ytx5j3FxaNgBemWVUmkUwpNkoJDXtuLjGzDsSCrIBhHji7qTEy7ZUTtKpemHvh48JqeH5V2I40gjZ2hOkyn_Ow7VtAGvc41YsjZtRvc98NAedjyU2Z2PwseHemtELEH-wH2OietSG70ozZN0lKYbyjjAChQROEPX45GMKSJnRD91e_S_BWrxLYkiCy2-6Bn8N96hg66dQYCcZkdPTQg52BfhKlY35bQqm4gqGyB19m9Gv3GCd0NJaS5Hj2LnUJ4wgBWTahL2b-nIWrJqBJon8_QLq8NFJVLA1WZ2u9oQhy-BAfdZK3d2Er-HqwlWaQahtBoolqPrI903wtNAeyNYfafvmGDtTf28GRBNIiEA-slRm-jE-UaZDguYaZ6DORvGOIN_S3pClkasNdXFWZ1ozNxZ6yBjZsv0FQE6ViyWa-2QCj407lnE9xipgR4yXR8CHYhC96j-rIammzJVrdVeeLRw6_W52kjkTmcqxy33B3jVx7p_0OWigLCSS1A9ZPk35anQ_34grif3SCRsLRoRTsRwLj-3h9JfXn2TFXzMVj0d9FM7uh_UYiBYR0brhGt9iZg1ZT1jb3Q8RTWOx1bdkAesTEDq-29zP4ypl0WF42B-o2E3oZ9v_4a7dfRNr_yhD1NmheMJE3LNm1QL3yqjMR5YNjhZKkaFfYWCHTMX7_maAG-yunGumbuyDRLgJjPz4mGGPzm9hsyZU31b6blYs-HIDh8e1oozmZzCdtkTbsxTB6Oceh2qQlHSSLrKukzdCzL7gsRRIdVN9zYE_JaJiCk7GLOX3KBN2TPozTQUZGFMkDYr8MucK3v4gLuFxbh5NJqx-QqD8Pj1t6Du1nohTd2ucGTVhP3AjXuVKBZKkMhXBZ2KeJ8SQWSAFuS9x-AV82_sXiFp1iuDkG71vR-Hdc9QFKLyDZfggJjJ6dEC6a5n-DprTkFVDwIYW1x7lYNOWEu1gDk17RVE6ixxaicYdjZ28ucYML3ZeMRoZSVBoi9o8AxT4f9tn8mCfEfOzDnomTNE_tZVcR_YZ9M-Xogm5TQLQ-Szij9e0GuvhJSy_Lbc7qzApGkysTaBaXPWZvBnj0r9QTzzaXwFlVe6MKGI09OiTOPzyILv91zUSxMi8HTWp0PXfwlqEt6p50YLmGpZ-rJVQggcsCOSb3DDC6Q_lnjMve-7MLaY8hMPV4tVnyGXhmTEutKrW4TsOsMg9mvCnGuWIlezYa8OJTZAzRUpahsKMqV4dZ1Ah3WniP0qTWTtMjXfduVS-1mJqmsn2S3C-4UEIjEJ14rAvTf0OeuPvQykkSehyQh3VF54LYOjBAqTRRaN14eVUBJogye5dny8B1z4Fw";
    const DROPBOX_FOLDER = "/komentar-web"; // folder yang kamu pilih

    // DOM refs
    const form = document.getElementById('commentForm');
    const usernameEl = document.getElementById('username');
    const commentEl = document.getElementById('comment');
    const ratingStars = document.querySelectorAll('#ratingStars .star');
    const commentsList = document.getElementById('commentsList');
    const totalCountEl = document.getElementById('totalCount');
    const avgRatingVisual = document.getElementById('avgRatingVisual');
    const avgStarsEl = document.getElementById('avgStars');
    const ratingHint = document.getElementById('ratingHint');
    const totalCountDisplay = document.getElementById('totalCount');
    const photoInput = document.getElementById('photoInput');
    const previewWrap = document.getElementById('previewWrap');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');

    let selectedRating = 0;
    let selectedFile = null;
    const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5MB

    // star behaviors
    ratingStars.forEach(star => {
      star.addEventListener('click', () => {
        selectedRating = Number(star.getAttribute('data-value'));
        updateStars(selectedRating);
      });
      star.addEventListener('mouseenter', () => {
        const v = Number(star.getAttribute('data-value'));
        highlightStars(v);
      });
      star.addEventListener('mouseleave', () => {
        updateStars(selectedRating);
      });
    });

    function highlightStars(r) {
      ratingStars.forEach(s => s.classList.toggle('filled', Number(s.getAttribute('data-value')) <= r));
    }
    function updateStars(r) {
      ratingStars.forEach(s => {
        s.classList.toggle('filled', Number(s.getAttribute('data-value')) <= r);
        s.textContent = Number(s.getAttribute('data-value')) <= r ? '★' : '☆';
      });
      ratingHint.textContent = r ? `Kamu memilih ${r} bintang` : 'Klik satu bintang untuk memilih rating.';
    }

    // preview image
    photoInput.addEventListener('change', (e) => {
      previewWrap.innerHTML = '';
      uploadProgress.classList.add('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      selectedFile = null;

      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (!f.type.startsWith('image/')) {
        alert('Silakan pilih file gambar (jpg/png).');
        photoInput.value = '';
        return;
      }
      if (f.size > MAX_FILE_BYTES) {
        alert('Ukuran file terlalu besar. Maks 5 MB.');
        photoInput.value = '';
        return;
      }

      selectedFile = f;
      const img = document.createElement('img');
      img.className = 'thumb';
      img.alt = 'Preview foto';
      img.src = URL.createObjectURL(f);
      previewWrap.appendChild(img);
    });

    // clear form
    clearBtn.addEventListener('click', () => {
      form.reset();
      selectedRating = 0;
      selectedFile = null;
      photoInput.value = '';
      previewWrap.innerHTML = '';
      updateStars(0);
    });

    // Upload helper: upload file to Dropbox with XHR so we can get progress
    function uploadFileToDropbox(file) {
      return new Promise((resolve, reject) => {
        const safeName = file.name.replace(/\s+/g, '_').replace(/[^\w\-.]/g, '');
        const path = `${DROPBOX_FOLDER}/${Date.now()}_${safeName}`;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://content.dropboxapi.com/2/files/upload');
        xhr.setRequestHeader('Authorization', 'Bearer ' + DROPBOX_ACCESS_TOKEN);
        xhr.setRequestHeader('Dropbox-API-Arg', JSON.stringify({ path: path, mode: 'add', autorename: true, mute: false }));
        xhr.setRequestHeader('Content-Type', 'application/octet-stream');

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = pct + '%';
            progressText.textContent = pct + '%';
          }
        };

        xhr.onload = async () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              // try create shared link
              const createRes = await fetch('https://api.dropboxapi.com/2/sharing/create_shared_link_with_settings', {
                method: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + DROPBOX_ACCESS_TOKEN,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path: path, settings: { requested_visibility: 'public' } })
              });

              const createData = await createRes.json();
              if (createRes.ok && createData.url) {
                const raw = createData.url.replace('?dl=0', '?raw=1');
                resolve({ url: raw, path });
                return;
              }

              // if create failed (maybe link already exists), try list_shared_links
              const listRes = await fetch('https://api.dropboxapi.com/2/sharing/list_shared_links', {
                method: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + DROPBOX_ACCESS_TOKEN,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path: path, direct_only: true })
              });
              const listData = await listRes.json();
              if (listRes.ok && listData && listData.links && listData.links.length > 0) {
                const raw = listData.links[0].url.replace('?dl=0', '?raw=1');
                resolve({ url: raw, path });
                return;
              }

              // as fallback, resolve without shared link (but UI expects imageUrl)
              resolve({ url: null, path });
            } catch (err) {
              reject(err);
            }
          } else {
            let body = xhr.responseText || '';
            reject(new Error('Upload failed: ' + xhr.status + ' ' + body));
          }
        };

        xhr.onerror = () => reject(new Error('Network/Connection error during upload.'));
        xhr.send(file);
      });
    }

    // submit handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = usernameEl.value.trim();
      const comment = commentEl.value.trim();

      if (!username || !comment) {
        alert('Isi nama & komentar terlebih dahulu.');
        return;
      }
      if (!selectedRating) {
        alert('Pilih rating (1–5 bintang).');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Mengirim...';
      try {
        let imageUrl = null;
        let imagePath = null;

        if (selectedFile) {
          uploadProgress.classList.remove('hidden');
          progressBar.style.width = '0%';
          progressText.textContent = '0%';

          const res = await uploadFileToDropbox(selectedFile);
          imageUrl = res.url; // mungkin null jika shared link gagal
          imagePath = res.path;
          // jika shared link gagal dan imageUrl null, kamu masih bisa menyimpan imagePath
        }

        await addDoc(collection(db, 'comments'), {
          username,
          comment,
          rating: selectedRating,
          imageUrl: imageUrl || null,
          imagePath: imagePath || null,
          createdAt: serverTimestamp()
        });

        form.reset();
        selectedRating = 0;
        selectedFile = null;
        photoInput.value = '';
        previewWrap.innerHTML = '';
        updateStars(0);
      } catch (err) {
        console.error('Gagal kirim komentar:', err);
        alert('Gagal mengirim komentar. Cek console untuk detail.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Kirim Komentar';
        uploadProgress.classList.add('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
      }
    });

    // realtime read and compute stats
    const q = query(collection(db, 'comments'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
      if (snapshot.empty) {
        commentsList.innerHTML = `<div class="card p-4 text-center">Belum ada komentar. Jadilah yang pertama!</div>`;
        totalCountDisplay.textContent = '0';
        avgRatingVisual.textContent = '-';
        avgStarsEl.textContent = '☆☆☆☆☆';
        return;
      }

      let html = '';
      let total = 0;
      let count = 0;

      snapshot.forEach(doc => {
        const d = doc.data();
        const rating = d.rating || 0;
        const username = d.username || 'Anonim';
        const comment = d.comment || '';
        const imageUrl = d.imageUrl || null;
        const createdAt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;

        total += Number(rating);
        count++;

        let timeStr = 'Baru saja';
        if (createdAt) timeStr = createdAt.toLocaleString();

        // construct card element safely
        const card = document.createElement('div');
        card.className = 'card p-4 flex gap-4 flex-col md:flex-row items-start';

        const left = document.createElement('div');
        left.style.flex = '0 0 auto';
        if (imageUrl) {
          const img = document.createElement('img');
          img.src = imageUrl;
          img.alt = 'Foto testimoni';
          img.className = 'thumb';
          left.appendChild(img);
        }

        const right = document.createElement('div');
        right.style.flex = '1';
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between mb-2';
        const nameEl = document.createElement('div');
        nameEl.className = 'font-semibold';
        nameEl.textContent = username;
        const ratingEl = document.createElement('div');
        ratingEl.innerHTML = `<span class="text-yellow-400">${'★'.repeat(rating)}${'☆'.repeat(5-rating)}</span>`;
        header.appendChild(nameEl);
        header.appendChild(ratingEl);

        const commentNode = document.createElement('div');
        commentNode.className = 'text-sm mt-1';
        commentNode.textContent = comment;

        const timeNode = document.createElement('div');
        timeNode.className = 'text-xs text-white/60 mt-2';
        timeNode.textContent = timeStr;

        right.appendChild(header);
        right.appendChild(commentNode);
        right.appendChild(timeNode);

        if (imageUrl) card.appendChild(left);
        card.appendChild(right);

        html += card.outerHTML;
      });

      commentsList.innerHTML = html;
      totalCountDisplay.textContent = String(count);

      const avg = (total / count) || 0;
      avgRatingVisual.textContent = avg ? avg.toFixed(2) : '-';
      const fullStars = Math.round(avg);
      avgStarsEl.innerHTML = '★'.repeat(fullStars) + '☆'.repeat(5 - fullStars);
    }, (err) => {
      console.error('Firestore onSnapshot error:', err);
      commentsList.innerHTML = `<div class="card p-4 text-center text-red-400">Gagal mengambil komentar (lihat console).</div>`;
    });

    // init
    updateStars(0);
  </script>
</body>
</html>
