<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Komentar — Muslih Fvnky Shop</title>
<style>
  :root{
    --bg1:#073f36; --bg2:#0f6b5f; --card:#0f4d45; --muted:#e6f2ef;
    --accent:#10d38b; --danger:#e05353;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial; background: radial-gradient( circle at 10% 10%, rgba(16,211,139,0.06), transparent 10%),
    linear-gradient(180deg, #083f36 0%, #073f36 40%, #053f32 100%); color:#fff;}
  .wrap{max-width:720px;margin:28px auto;padding:18px;}
  .hero{display:flex;gap:16px;align-items:center;margin-bottom:18px}
  .logo{width:72px;height:72px;background:#054;margin-right:8px;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,0.3)}
  h1{font-size:30px;margin:0 0 6px}
  .sub{opacity:.85;color:#d5efe6;margin-bottom:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); padding:20px;border-radius:14px;box-shadow:0 12px 40px rgba(2,20,18,0.45); margin-bottom:18px}
  label{display:block;font-weight:600; color: #d9efe6;margin-bottom:8px}
  input[type="text"], textarea{width:100%;padding:14px;border-radius:10px;border:0;background:#f3f7f6;color:#05231e;font-size:16px;box-shadow: inset 0 1px 0 rgba(255,255,255,0.03)}
  textarea{min-height:120px;resize:vertical}
  .stars{display:flex;gap:8px;align-items:center;margin:8px 0 16px}
  .star{font-size:26px;color: #bbb; cursor:pointer; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25))}
  .star.on{color: #ffd24a}
  .file-row{display:flex;gap:12px;align-items:center;margin:10px 0}
  .file-btn{background:#fff;color:#05231e;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;border:none}
  .progress{width:100%;height:8px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;margin-top:8px}
  .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#05b08b)}
  .actions{display:flex;gap:12px;margin-top:16px}
  .btn{padding:12px 18px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn-send{background:var(--accent);color:#02261e;box-shadow: 0 10px 20px rgba(16,211,139,0.12)}
  .btn-reset{background:rgba(255,255,255,0.08);color:#e9fff6}
  .msg{margin-top:16px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.35);display:flex;gap:12px;align-items:center}
  .msg.error{background:rgba(224,77,77,0.12);color:#ffd7d7}
  .msg.success{background:rgba(16,211,139,0.08);color:#d8ffef}
  .comments-list{margin-top:20px}
  .comment-item{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px;margin-bottom:12px}
  .comment-meta{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .comment-img{width:64px;height:64px;border-radius:8px;object-fit:cover}
  .small{font-size:13px;opacity:.9;color:#d8efe6}
  @media(max-width:520px){ .wrap{padding:12px} h1{font-size:24px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="logo"></div>
      <div>
        <h1>Komentar Pengunjung ★</h1>
        <div class="sub">Pengunjung dapat memberi rating, komentar, dan upload foto — tampil otomatis.</div>
      </div>
    </div>

    <div class="card">
      <form id="commentForm">
        <label for="name">Nama</label>
        <input id="name" name="name" type="text" placeholder="Nama kamu (atau panggilan)" required />

        <label for="comment" style="margin-top:12px">Komentar</label>
        <textarea id="comment" name="comment" placeholder="Tulis pengalamanmu"></textarea>

        <label style="margin-top:12px">Rating</label>
        <div class="stars" id="stars">
          <span class="star" data-value="1">☆</span>
          <span class="star" data-value="2">☆</span>
          <span class="star" data-value="3">☆</span>
          <span class="star" data-value="4">☆</span>
          <span class="star" data-value="5">☆</span>
          <div style="flex:1;text-align:right;color:#cfeee0" id="ratingText">Kamu memilih 0</div>
        </div>

        <label>Upload Foto (opsional, max 5 MB)</label>
        <div class="file-row">
          <label class="file-btn">
            Pilih File
            <input id="file" name="file" type="file" accept="image/*" style="display:none" />
          </label>
          <div id="fileName" class="small">Tidak ada file yang dipilih</div>
        </div>

        <div class="progress" aria-hidden><i id="progBar"></i></div>

        <div class="actions">
          <button type="submit" class="btn btn-send">Kirim Komentar</button>
          <button type="button" id="resetBtn" class="btn btn-reset">Reset</button>
        </div>

        <div id="messageArea"></div>
      </form>
    </div>

    <div class="comments-list" id="commentsList">
      <!-- komentar akan muncul di sini -->
    </div>
  </div>

<script>
(function(){
  const stars = document.querySelectorAll('.star');
  const ratingText = document.getElementById('ratingText');
  let rating = 0;
  stars.forEach(s=>{
    s.addEventListener('click', ()=> {
      rating = Number(s.dataset.value);
      updateStars();
    });
  });
  function updateStars(){
    stars.forEach(s => {
      s.classList.toggle('on', Number(s.dataset.value) <= rating);
      s.textContent = Number(s.dataset.value) <= rating ? '★' : '☆';
    });
    ratingText.textContent = 'Kamu memilih ' + rating;
  }

  const fileInput = document.getElementById('file');
  const fileName = document.getElementById('fileName');
  fileInput.addEventListener('change', ()=> {
    const f = fileInput.files[0];
    fileName.textContent = f ? `${f.name} (${Math.round(f.size/1024)} KB)` : 'Tidak ada file yang dipilih';
  });

  const form = document.getElementById('commentForm');
  const msgArea = document.getElementById('messageArea');
  const progBar = document.getElementById('progBar');
  const commentsList = document.getElementById('commentsList');

  function showMessage(type, text){
    msgArea.innerHTML = `<div class="msg ${type==='error'? 'error' : 'success'}"> ${ type==='error' ? '❌ ' : '✅ ' } ${text}</div>`;
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msgArea.innerHTML = '';
    progBar.style.width = '0%';

    const name = document.getElementById('name').value.trim();
    const comment = document.getElementById('comment').value.trim();

    if(!name){ showMessage('error','Nama diperlukan'); return; }

    const fd = new FormData();
    fd.append('name', name);
    fd.append('comment', comment);
    fd.append('rating', rating || 0);
    if(fileInput.files[0]) fd.append('file', fileInput.files[0]);

    try{
      const res = await fetch('/api/upload', { method:'POST', body: fd });
      const text = await res.text();
      let data;
      try{ data = JSON.parse(text); } catch(e) {
        showMessage('error', 'Error koneksi: Response bukan JSON. Server menanggapi: ' + text.slice(0,200));
        return;
      }

      if(!res.ok){
        showMessage('error', data && data.error ? ('Error koneksi: ' + data.error) : 'Server error');
        return;
      }
      // sukses
      showMessage('success', 'Komentar terkirim — tampil di halaman.');
      // tambahkan ke daftar komentar client-side agar langsung terlihat
      addCommentToList(data.comment || { name, comment, rating, image: data.image || data.comment?.image || null, created: (new Date()).toISOString() });
      form.reset(); rating = 0; updateStars(); fileName.textContent = 'Tidak ada file yang dipilih';
      progBar.style.width = '100%';
    }catch(err){
      console.error(err);
      showMessage('error', 'Server error: ' + (err.message || err));
    }
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    form.reset(); rating = 0; updateStars(); fileName.textContent = 'Tidak ada file yang dipilih';
    msgArea.innerHTML='';
  });

  function addCommentToList(c){
    const div = document.createElement('div');
    div.className = 'comment-item';
    div.innerHTML = `
      <div class="comment-meta">
        ${ c.image ? `<img src="${c.image}" class="comment-img" />` : '' }
        <div>
          <div style="font-weight:700">${escapeHtml(c.name)}</div>
          <div class="small">${new Date(c.created||Date.now()).toLocaleString()}</div>
        </div>
      </div>
      <div style="margin-top:6px">${escapeHtml(c.comment)}</div>
      <div class="small" style="margin-top:8px">Rating: ${Number(c.rating)||0} ★</div>
    `;
    commentsList.insertBefore(div, commentsList.firstChild);
  }

  function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

  // Optional: you could fetch existing comments.json via an API route /api/comments if implemented.
})();
</script>
</body>
</html>
